import { useState, useEffect } from 'react';
import PatientLayout from '../../components/layout/PatientLayout';
import patientService from '../../services/patientService';
import {
  CogIcon,
  BellIcon,
  ShieldCheckIcon,
  MoonIcon,
  SunIcon,
  GlobeAltIcon,
  EnvelopeIcon,
  DevicePhoneMobileIcon,
  LockClosedIcon,
  KeyIcon,
  UserCircleIcon,
  CheckCircleIcon,
  ExclamationCircleIcon,
} from '@heroicons/react/24/outline';

const Settings = () => {
  const [settings, setSettings] = useState({
    // Notifications
    emailNotifications: true,
    smsNotifications: false,
    appointmentReminders: true,
    promotionalEmails: false,

    // Theme
    darkMode: false,

    // Language
    language: 'fr',

    // Security
    twoFactorAuth: false,
    biometricAuth: false,
  });

  const [isSaving, setIsSaving] = useState(false);
  const [saveSuccess, setSaveSuccess] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  // Charger les param√®tres depuis le backend
  useEffect(() => {
    const loadSettings = async () => {
      try {
        setIsLoading(true);
        setError(null);
        const response = await patientService.getProfile();
        const user = response.data;

        setSettings({
          emailNotifications: user.preferencesNotifEmail,
          smsNotifications: user.preferencesNotifSms,
          appointmentReminders: user.preferencesRappels,
          promotionalEmails: user.preferencesPromotions,
          darkMode: user.theme === 'SOMBRE',
          language: user.langue,
          twoFactorAuth: user.twoFactorAuth,
          biometricAuth: user.biometricAuth,
        });
      } catch (err) {
        console.error('Erreur lors du chargement des param√®tres:', err);
        setError('Impossible de charger les param√®tres');
      } finally {
        setIsLoading(false);
      }
    };

    loadSettings();
  }, []);

  const handleToggle = (key) => {
    setSettings(prev => ({
      ...prev,
      [key]: !prev[key]
    }));
  };

  const handleLanguageChange = (lang) => {
    setSettings(prev => ({
      ...prev,
      language: lang
    }));
  };

  const handleSave = async () => {
    try {
      setIsSaving(true);
      setSaveSuccess(false);
      setError(null);

      // Pr√©parer les donn√©es pour l'API
      const updateData = {
        preferencesNotifEmail: settings.emailNotifications,
        preferencesNotifSms: settings.smsNotifications,
        preferencesRappels: settings.appointmentReminders,
        preferencesPromotions: settings.promotionalEmails,
        theme: settings.darkMode ? 'SOMBRE' : 'CLAIR',
        langue: settings.language,
        twoFactorAuth: settings.twoFactorAuth,
        biometricAuth: settings.biometricAuth,
      };

      console.log('Donn√©es envoy√©es:', updateData);
      const response = await patientService.updatePreferences(updateData);
      console.log('R√©ponse re√ßue:', response.data);

      setIsSaving(false);
      setSaveSuccess(true);

      // Reset success message after 3 seconds
      setTimeout(() => setSaveSuccess(false), 3000);
    } catch (err) {
      console.error('Erreur lors de la sauvegarde des param√®tres:', err);
      console.error('D√©tails de l\'erreur:', err.response?.data);
      setError(err.response?.data?.message || 'Impossible de sauvegarder les param√®tres');
      setIsSaving(false);
    }
  };

  const settingSections = [
    {
      id: 'notifications',
      title: 'Notifications',
      icon: BellIcon,
      gradient: 'secondary-500',
      description: 'G√©rez vos pr√©f√©rences de notifications',
      settings: [
        {
          id: 'emailNotifications',
          label: 'Notifications par email',
          description: 'Recevoir des notifications par email',
          icon: EnvelopeIcon,
        },
        {
          id: 'smsNotifications',
          label: 'Notifications par SMS',
          description: 'Recevoir des notifications par SMS',
          icon: DevicePhoneMobileIcon,
        },
        {
          id: 'appointmentReminders',
          label: 'Rappels de rendez-vous',
          description: 'Recevoir des rappels avant vos rendez-vous',
          icon: BellIcon,
        },
        {
          id: 'promotionalEmails',
          label: 'Emails promotionnels',
          description: 'Recevoir des offres et promotions',
          icon: EnvelopeIcon,
        },
      ],
    },
    {
      id: 'appearance',
      title: 'Apparence',
      icon: settings.darkMode ? MoonIcon : SunIcon,
      gradient: 'primary-400',
      description: 'Personnalisez l\'apparence de l\'application',
      settings: [
        {
          id: 'darkMode',
          label: 'Mode sombre',
          description: 'Activer le th√®me sombre',
          icon: MoonIcon,
        },
      ],
    },
    {
      id: 'security',
      title: 'S√©curit√©',
      icon: ShieldCheckIcon,
      gradient: 'secondary-500',
      description: 'Renforcez la s√©curit√© de votre compte',
      settings: [
        {
          id: 'twoFactorAuth',
          label: 'Authentification √† deux facteurs',
          description: 'Ajouter une couche de s√©curit√© suppl√©mentaire',
          icon: KeyIcon,
        },
        {
          id: 'biometricAuth',
          label: 'Authentification biom√©trique',
          description: 'Utiliser votre empreinte digitale ou Face ID',
          icon: LockClosedIcon,
        },
      ],
    },
  ];

  const languages = [
    { code: 'fr', name: 'Fran√ßais', flag: 'üá´üá∑' },
    { code: 'en', name: 'English', flag: 'üá¨üáß' },
    { code: 'ar', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', flag: 'üá≤üá¶' },
  ];

  // Afficher un loader pendant le chargement
  if (isLoading) {
    return (
      <PatientLayout>
        <div className="min-h-screen bg-slate-50 p-8 flex items-center justify-center">
          <div className="text-center">
            <div className="w-16 h-16 border-4 border-secondary-500/30 border-t-secondary-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p className="text-slate-600 font-medium">Chargement des param√®tres...</p>
          </div>
        </div>
      </PatientLayout>
    );
  }

  return (
    <PatientLayout>
      <div className="min-h-screen bg-slate-50 p-8">
        {/* Animated background elements */}
        <div className="fixed inset-0 overflow-hidden pointer-events-none">
          <div className="absolute -top-40 -right-40 w-96 h-96 bg-secondary-400/20 rounded-full blur-3xl animate-blob"></div>
          <div className="absolute -bottom-40 -left-40 w-96 h-96 bg-primary-400/20 rounded-full blur-3xl animate-blob animation-delay-2000"></div>
        </div>

        <div className="relative max-w-6xl mx-auto space-y-8">
          {/* Error Message */}
          {error && (
            <div className="relative bg-red-500/10 backdrop-blur-xl rounded-2xl p-6 border border-red-200/50 shadow-lg animate-scale-in">
              <div className="flex items-start gap-4">
                <div className="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center shadow-lg flex-shrink-0">
                  <ExclamationCircleIcon className="w-6 h-6 text-white" />
                </div>
                <div>
                  <h4 className="font-bold text-slate-800 mb-1">Erreur</h4>
                  <p className="text-sm text-slate-600 leading-relaxed">{error}</p>
                </div>
              </div>
            </div>
          )}
          {/* Header */}
          <div className="relative group animate-scale-in">
            <div className="absolute inset-0 bg-secondary-500/20 rounded-3xl blur-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
            <div className="relative bg-white/80 backdrop-blur-xl rounded-3xl shadow-2xl p-8 border border-white/50">
              <div className="flex items-center gap-4">
                <div className="relative">
                  <div className="absolute inset-0 bg-secondary-500 rounded-2xl blur-lg opacity-75 animate-pulse-soft"></div>
                  <div className="relative w-16 h-16 bg-secondary-500 rounded-2xl flex items-center justify-center shadow-xl">
                    <CogIcon className="w-8 h-8 text-white animate-rotate-slow" />
                  </div>
                </div>
                <div>
                  <h1 className="text-4xl font-bold text-secondary-500">
                    Param√®tres
                  </h1>
                  <p className="text-slate-600 mt-1 font-medium">
                    Personnalisez votre exp√©rience
                  </p>
                </div>
              </div>
            </div>
          </div>

          {/* Language Selection */}
          <div className="relative animate-slide-up" style={{ animationDelay: '100ms' }}>
            <div className="relative group">
              <div className="absolute inset-0 bg-primary-400/20 rounded-2xl blur-xl opacity-0 group-hover:opacity-100 transition-opacity"></div>
              <div className="relative bg-white/80 backdrop-blur-xl rounded-2xl shadow-lg p-6 border border-white/50">
                <div className="flex items-center gap-3 mb-4">
                  <div className="w-10 h-10 bg-primary-400 rounded-xl flex items-center justify-center shadow-lg">
                    <GlobeAltIcon className="w-5 h-5 text-white" />
                  </div>
                  <div>
                    <h3 className="text-lg font-bold text-slate-800">Langue</h3>
                    <p className="text-sm text-slate-500">Choisissez votre langue pr√©f√©r√©e</p>
                  </div>
                </div>

                <div className="grid grid-cols-3 gap-4">
                  {languages.map((lang, index) => (
                    <button
                      key={lang.code}
                      onClick={() => handleLanguageChange(lang.code)}
                      className={`relative p-4 rounded-xl transition-all duration-300 hover:scale-105 animate-scale-in ${
                        settings.language === lang.code
                          ? 'bg-primary-400 text-white shadow-xl'
                          : 'bg-white/60 text-slate-700 hover:bg-white shadow-md'
                      }`}
                      style={{ animationDelay: `${index * 50}ms` }}
                    >
                      {settings.language === lang.code && (
                        <div className="absolute inset-0 bg-primary-400 rounded-xl blur-lg opacity-50 animate-pulse-soft"></div>
                      )}
                      <div className="relative text-center">
                        <div className="text-3xl mb-2">{lang.flag}</div>
                        <div className="font-semibold">{lang.name}</div>
                      </div>
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* Settings Sections */}
          {settingSections.map((section, sectionIndex) => (
            <div
              key={section.id}
              className="relative animate-slide-up"
              style={{ animationDelay: `${(sectionIndex + 2) * 100}ms` }}
            >
              <div className="relative group">
                <div className={`absolute inset-0 bg-${section.gradient} opacity-10 rounded-2xl blur-xl group-hover:opacity-20 transition-opacity`}></div>
                <div className="relative bg-white/80 backdrop-blur-xl rounded-2xl shadow-lg p-6 border border-white/50">
                  {/* Section Header */}
                  <div className="flex items-center gap-3 mb-6">
                    <div className={`w-12 h-12 bg-${section.gradient} rounded-xl flex items-center justify-center shadow-lg`}>
                      <section.icon className="w-6 h-6 text-white" />
                    </div>
                    <div>
                      <h3 className="text-xl font-bold text-slate-800">{section.title}</h3>
                      <p className="text-sm text-slate-500">{section.description}</p>
                    </div>
                  </div>

                  {/* Settings Items */}
                  <div className="space-y-4">
                    {section.settings.map((setting, index) => (
                      <div
                        key={setting.id}
                        className="relative group/item"
                      >
                        <div className="flex items-center justify-between p-4 rounded-xl bg-white/60 hover:bg-white transition-all duration-300 hover:shadow-md">
                          <div className="flex items-center gap-4 flex-1">
                            <div className={`w-10 h-10 bg-${section.gradient} opacity-20 rounded-lg flex items-center justify-center`}>
                              <setting.icon className="w-5 h-5 text-slate-600" />
                            </div>
                            <div>
                              <h4 className="font-semibold text-slate-800">{setting.label}</h4>
                              <p className="text-sm text-slate-500">{setting.description}</p>
                            </div>
                          </div>

                          {/* Toggle Switch */}
                          <button
                            onClick={() => handleToggle(setting.id)}
                            className={`relative w-14 h-7 rounded-full transition-all duration-300 ${
                              settings[setting.id]
                                ? `bg-${section.gradient}`
                                : 'bg-slate-200'
                            }`}
                          >
                            <div
                              className={`absolute top-1 w-5 h-5 bg-white rounded-full shadow-md transition-all duration-300 ${
                                settings[setting.id] ? 'left-8' : 'left-1'
                              }`}
                            ></div>
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          ))}

          {/* Save Button */}
          <div className="relative animate-slide-up" style={{ animationDelay: '500ms' }}>
            <div className="flex items-center justify-between">
              <div>
                {saveSuccess && (
                  <div className="flex items-center gap-2 text-green-600 font-semibold animate-scale-in">
                    <CheckCircleIcon className="w-6 h-6" />
                    Param√®tres enregistr√©s avec succ√®s!
                  </div>
                )}
              </div>

              <button
                onClick={handleSave}
                disabled={isSaving}
                className="relative group/btn px-8 py-4 rounded-2xl overflow-hidden bg-secondary-500 text-white font-bold shadow-2xl hover:shadow-3xl hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <div className="absolute inset-0 bg-secondary-600 opacity-0 group-hover/btn:opacity-100 transition-opacity"></div>
                <div className="relative flex items-center gap-2">
                  {isSaving ? (
                    <>
                      <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                      Enregistrement...
                    </>
                  ) : (
                    <>
                      <CheckCircleIcon className="w-6 h-6" />
                      Enregistrer les modifications
                    </>
                  )}
                </div>
              </button>
            </div>
          </div>

          {/* Security Info Banner */}
          <div className="relative bg-secondary-500/10 backdrop-blur-xl rounded-2xl p-6 border border-secondary-200/50 shadow-lg animate-slide-up" style={{ animationDelay: '600ms' }}>
            <div className="flex items-start gap-4">
              <div className="w-12 h-12 bg-secondary-500 rounded-xl flex items-center justify-center shadow-lg flex-shrink-0">
                <ShieldCheckIcon className="w-6 h-6 text-white" />
              </div>
              <div>
                <h4 className="font-bold text-slate-800 mb-1">Conseil de s√©curit√©</h4>
                <p className="text-sm text-slate-600 leading-relaxed">
                  Pour prot√©ger votre compte, nous vous recommandons d'activer l'authentification √† deux facteurs et de changer r√©guli√®rement votre mot de passe.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </PatientLayout>
  );
};

export default Settings;
